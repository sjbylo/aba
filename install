#!/bin/bash
# Simple Aba installer.  Copy aba command somewhere into the $PATH
#
# Usage:
#   ./install          - Manual install (verbose, resets ~/.aba/*, forces reinstall)
#   ./install -q       - Quiet mode (minimal output, preserves ~/.aba/*, updates only if changed)
#
# The -q flag is used internally by 'aba' command for automatic update checks

uname -o | grep -q "^Darwin$" && echo "Install ABA on RHEL, Centos Stream or Fedora.  Most tested is RHEL 8 or 9 (no oc-mirror for Mac OS!)." >&2 && exit 1

# We need git, which, id, diff commands to run this script (not always available in a container) ... 
# Other rpm packages that ABA requires are copied into the below lines at build time (which aren't available yet!)
required_pkgs=(which file hostname diffutils git make jq python3-jinja2 python3-pyyaml ncurses)
required_pkgs+=(make jq python3-jinja2 python3-pyyaml ncurses which diffutils dialog podman httpd-tools skopeo)  # Synced from templates/rpms-external.txt
required_pkgs+=(make jq python3-jinja2 python3-pyyaml ncurses which file hostname diffutils podman bind-utils nmstate net-tools skopeo openssl coreos-installer httpd)  # Synced from templates/rpms-internal.txt
required_pkgs=($(printf '%s\n' "${required_pkgs[@]}" | sort -u))  # Deduplicate
missing_pkgs=()

# Check which packages are missing ...
for pkg in "${required_pkgs[@]}"; do
	if ! rpm -q "$pkg" >/dev/null; then
		missing_pkgs+=("$pkg")
	fi
done

# If sudo is not found, assume we are running as root
SUDO=
which sudo 2>/dev/null >&2 && SUDO=sudo

if [ ${#missing_pkgs[@]} -gt 0 ]; then
	# try our luck to install the missing packages ...
	echo "Installing required rpms: ${missing_pkgs[*]} (logging to .dnf-install.log). Please wait!"

	if ! $SUDO dnf install ${missing_pkgs[*]} -y >.dnf-install.log 2>&1; then
		echo
		echo "Error installing required packages. See: .dnf-install.log" >&2
		echo "Install the correct rpm packages (${missing_pkgs[*]}) and try again." >&2

		exit 1
	fi
fi

if ! which id >/dev/null 2>&1; then
	echo "Please install the command 'id', usually in the coreutils package and try again." >&2

	exit 1
fi

# Now, check sudo or root access.
# If user is not root ...
if [ "$(id -u)" != "0" ]; then
	if [ "$SUDO" ]; then
		# If sudo does not lead to root without using a password prompt (-n)
		if [ "$($SUDO -n whoami)" != "root" ]; then
			echo "ABA requires root access, directly or via sudo." >&2
			# If there is no passwordless access
			if ! $SUDO -ln 2>/dev/null | grep -q NOPASSWD; then
				echo "Passwordless sudo access is recommended." >&2
			fi
			echo -n "You must enter your password to install and use ABA: " >&2
			[ "$($SUDO -p "Enter %p's password: " id -run)" != "root" ] && echo "Configure passwordless sudo OR run ABA as root, then try again!" >&2 && exit 1
		fi
	else
		echo "Error: sudo command is not available and ABA is not running as root!" >&2
		exit 1  # Should never get here!
	fi
fi

# Check options
while echo "$1" | grep -q "^-"
do
	# -q: Quiet mode (suppress verbose output, preserve ~/.aba state, update aba script only if changed)
	[ "$1" = "-q" ] && quiet=1 && shift
	[ "$1" = "-v" ] && cur_ver=$2 && shift 2
done

branch=main
repo=sjbylo/aba
msg=

# Required args
[ "$1" ] && branch="$1"
[ "$2" ] && repo="$2"

is_repo_available() {
	[ -s ./scripts/aba.sh -a -x ./scripts/aba.sh ] && return 0
	# If curl is used...
	[ "$0" = "--" -o "$0" = "bash" ] && return 1

	# We must have the repo, cd into it...
	cd $(dirname $0)
	return 0
}

download_repo() {
	if ! which git 2>/dev/null >&2; then
		echo "Please install git and try again!" >&2

		exit 1
	fi

	if ! grep -q "Top level Makefile" Makefile 2>/dev/null; then
		echo Cloning ABA with: "git clone --depth 1 -b $branch https://github.com/${repo}.git" >&2
		if ! git clone --depth 1 -b $branch https://github.com/${repo}.git; then
			echo "Error fetching git repo from https://github.com/${repo}.git (branch: $branch)" >&2

			exit 1
		fi

		echo
		[ "$PWD" = "/" ] && echo "Cloned ABA branch $branch into /aba" >&2 || echo "Cloned ABA branch $branch into $PWD/aba" >&2
		cd aba
	fi
}

aba_is_installed() {
	# if aba is not installed then consider no current ver
	which aba >/dev/null 2>&1 && return 0 || return 1
}

if ! is_repo_available; then
	download_repo
	msg="Run: 'cd aba; aba' or see the README.md file"
fi

# Sanity check ...
[ ! -x scripts/aba.sh ] && echo "Abort: Incomplete ABA repo! aba script not found in $PWD/scripts/aba.sh" >&2 && exit 1

mkdir -p ~/.aba

# Always write ssh.conf so upgrades can add new options (e.g. BatchMode)
cat > ~/.aba/ssh.conf <<END
StrictHostKeyChecking no
UserKnownHostsFile=/dev/null
ConnectTimeout=15
BatchMode=yes
LogLevel=ERROR
END

# Create user config file if needed
if [ ! -f ~/.aba/config ]; then
	# Derive script directory (install script is in ABA root)
	INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	TEMPLATE="$INSTALL_DIR/templates/aba-home-config"
	
	if [ -f "$TEMPLATE" ]; then
		cp "$TEMPLATE" ~/.aba/config
	else
		echo "Warning: Template not found at $TEMPLATE" >&2
		echo "Skipping ~/.aba/config creation" >&2
	fi
fi


source scripts/include_all.sh

# Most (or all) rpms are installed above.... but ...
# Now double-check we have all the required rpms from the file: templates/rpms-external.txt
[ -d templates ] && install_rpms $(cat templates/rpms-external.txt) # HACK - show not be needed to check
[ -d ../templates ] && install_rpms $(cat ../templates/rpms-external.txt) # HACK - show not be needed to check

# Reset ~/.aba state on manual install only
# When -q flag is used (automatic update check from 'aba' command), preserve user state
if [ ! "$quiet" ]; then
	if [ -d ~/.aba/runner ] || [ -d ~/.aba/cache ]; then
		rm -rf ~/.aba/runner ~/.aba/cache
		echo Cache deleted
	fi
fi


# Install aba somewhere into the $PATH, in this priority order 
for d in "$HOME/bin" /usr/local/bin /usr/local/sbin /usr/bin /usr/sbin
do
	# Check is the proposed dir exists in $PATH
	#if echo $PATH | grep -q -e "$d:" -e "$d$"; then
	if echo ":$PATH:" | grep -q -e ":$d:"; then
		action=
		ret=0 # default return value
		if [ -s "$d/aba" -a -x "$d/aba" ]; then
			# Compare installed aba with repo version using diff.
			# This reliably detects ANY change (upgrades, downgrades, dev builds)
			# without relying on version or timestamp comparisons.
			[ -n "${DEBUG_ABA-}" ] && echo "Comparing $d/aba with scripts/aba.sh" >&2
			if diff -q "$d/aba" scripts/aba.sh >/dev/null 2>&1; then
				# Installed aba is identical to repo — genuinely up-to-date
				[ ! "$quiet" ] && echo ABA is already up-to-date >&2
				exit 0
			else
				# Installed aba differs from repo — update needed.
				# In quiet mode (-q), return 2 so aba.sh can re-exec itself
				# with the updated script (see scripts/aba.sh auto-update logic).
				# In manual mode (user ran ./install), return 0 as normal.
				action=updated
				if [ "$quiet" ]; then
					ret=2
				else
					ret=0
				fi
			fi
		else
			action=installed
			aba-track # Note this tracker has only one counter: 'installed'
			ret=0
		fi

		# If it's ~/bin and it's missing create it
		[ "$d" = "$HOME/bin" -a ! -d $d ] && mkdir -p $d

		# Now, try to install aba
		if $SUDO cp -p scripts/aba.sh $d/aba; then
			$SUDO chmod +x $d/aba
			if [ ! "$quiet" ]; then
				echo ABA has been $action to $d/aba >&2
				if [ -n "$msg" ]; then
					###source scripts/include_all.sh
					echo_yellow "$msg" >&2
				fi
			fi

			exit $ret  # Success - if aba updates itself, ret=2 
		fi
	fi
done

[ ! "$quiet" ] && echo "Cannot install $PWD/scripts/aba.sh!  Please copy it into your \$PATH and name it 'aba'." >&2

exit 1

